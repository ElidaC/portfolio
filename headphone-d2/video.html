<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://use.typekit.net/sty5dnx.css">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=League+Spartan:wght@100..900&family=Original+Surfer&family=Ribeye&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
  <title>Outline Camera with Background</title>
  <style>
    :root{
      --frame-w: min(860px, 92vw);
      --frame-h: calc(var(--frame-w) * 9 / 16);
    }

    html, body { height: 100%; }
    body{
      margin:0;
      display:grid;
      place-items:center;
      background:url("bg/bg.png") center / cover no-repeat;
    }

    .frame{
      width: var(--frame-w);
      height: var(--frame-h);
      position: absolute;
      overflow: hidden;
      background: white;
      top: 20%;
      left: 17%;
    }

    /* 固定背景图 */
    .bg{
      position:absolute;
      inset:0;
      background: transparent;
    }

    /* 轮廓画布 */
    canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
    }

    /* 隐藏的视频源 */
    video{
      position:absolute;
      inset:0;
      opacity:0;
      pointer-events:none;
    }

    .err{
      margin-top: 10px;
      color:#ffb4b4;
      font-size: 13px;
      white-space: pre-wrap;
      text-align:center;
    }

    .heading{
        font-size: 60pt;
    }

    #L{
        position: absolute;
        top: 3%;
        left: 5%;
    }

    #I{
        position: absolute;
        bottom: 15%;
        right: 5%;
        rotate: -90deg;
    }

    #B{
        position: absolute;
        bottom: 2%;
        right: 5%;
    }

    p{
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        font-size: 15pt;
        font-weight: 300;
    }

    .hint{
        position: absolute;
        top: 12%;
        right: 5%;
    }

    a{
        color: black;
        font-weight: 700;
    }
  </style>
</head>







<body>
  <div>
    <div class="frame">
      <div class="bg"></div>
      <canvas id="out"></canvas>
      <video id="cam" autoplay playsinline muted></video>
    </div>
    <div id="err" class="err"></div>
  </div>

  <div class="heading">
    <h1 id="L">Listening</h1>
    <h1 id="I">in</h1>
    <h1 id="B">Between</h1>
  </div>

  <div class="hint">
    <p>Put on the headphones and <a href="index.html">dive in</a>...</p>
  </div>



















  <script>
    const video = document.getElementById('cam');
    const canvas = document.getElementById('out');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const errBox = document.getElementById('err');

    const THRESHOLD = 155;  
    const THICKNESS = 0;   
    const MIRROR = true;  

    function resizeCanvas() {
      canvas.width = video.videoWidth || 1280;
      canvas.height = video.videoHeight || 720;
    }

    async function startCamera(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: false,
          video: {
            facingMode: "user",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
        video.srcObject = stream;
      }catch(e){
        errBox.textContent =
          "摄像头启动失败：\n" +
          (e?.name ? e.name + ": " : "") +
          (e?.message || String(e));
      }
    }

    function renderOutline(){
      if (video.readyState < 2) {
        requestAnimationFrame(renderOutline);
        return;
      }

      if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
        resizeCanvas();
      }

      const w = canvas.width;
      const h = canvas.height;

      // 画视频帧到 canvas（仅用于取像素）
      ctx.save();
      ctx.clearRect(0,0,w,h);
      if (MIRROR) {
        ctx.translate(w, 0);
        ctx.scale(-1, 1);
      }
      ctx.drawImage(video, 0, 0, w, h);
      ctx.restore();

      const img = ctx.getImageData(0, 0, w, h);
      const data = img.data;

      // 灰度
      const gray = new Uint8ClampedArray(w * h);
      for (let i = 0, p = 0; i < data.length; i += 4, p++) {
        gray[p] = (0.2126*data[i] + 0.7152*data[i+1] + 0.0722*data[i+2]) | 0;
      }

      // Sobel 边缘检测
      const edges = new Uint8ClampedArray(w * h);

      for (let y = 1; y < h - 1; y++) {
        for (let x = 1; x < w - 1; x++) {
          const i = y * w + x;

          const a00 = gray[i - w - 1], a01 = gray[i - w], a02 = gray[i - w + 1];
          const a10 = gray[i - 1],     a12 = gray[i + 1];
          const a20 = gray[i + w - 1], a21 = gray[i + w], a22 = gray[i + w + 1];

          const gx = (-a00 + a02) + (-2*a10 + 2*a12) + (-a20 + a22);
          const gy = ( a00 + 2*a01 + a02) + (-a20 - 2*a21 - a22);

          const mag = Math.abs(gx) + Math.abs(gy);
          edges[i] = mag > THRESHOLD ? 255 : 0;
        }
      }

      // 输出：透明背景 + 黑色轮廓
      const out = ctx.createImageData(w, h);
      const od = out.data;

      for (let i = 0, p = 0; p < edges.length; p++, i += 4) {
        if (edges[p] === 255) {
          od[i] = 0;
          od[i+1] = 0;
          od[i+2] = 0;
          od[i+3] = 255;
        } else {
          od[i+3] = 0; // 透明
        }
      }

      ctx.putImageData(out, 0, 0);
      requestAnimationFrame(renderOutline);
    }

    if (navigator.mediaDevices?.getUserMedia) {
      startCamera();
      video.addEventListener('loadedmetadata', () => {
        resizeCanvas();
        renderOutline();
      }, { once: true });
    } else {
      errBox.textContent = "当前浏览器不支持摄像头 API（getUserMedia）。";
    }
  </script>
</body>
</html>